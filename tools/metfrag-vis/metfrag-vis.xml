<tool id="metfrag_vis" name="MetFrag Vis" version="2.4.5+galaxy0" profile="18.01">
    <description>
        Visualisation for MetFrag results
    </description>
    <requirements>
        <requirement type="package" version="2.4.5">metfrag</requirement>
        <requirement type="package" version="0.9">cdk-inchi-to-svg</requirement>
        <requirement type="package" version="3.7.3">python</requirement>
        <requirement type="package" version="1.0.4">pubchempy</requirement>
        <requirement type="package">matplotlib</requirement>
        <requirement type="package">requests</requirement>
        <requirement type="package">numpy</requirement>
    </requirements>
    <stdio>
        <regex match="Cannot allocate memory"
           source="stderr"
           level="fatal_oom"
           description="Out of memory error occurred" />
    </stdio>
    <command detect_errors="exit_code">
    <![CDATA[
         python '$__tool_directory__/metfrag-vis.py'
            -i $metfrag_vis_input
            -o $metfrag_vis_output
            -m $metfrag_vis_hits_limit
            $metfrag_synonyms
            $metfrag_classyfire
    ]]></command>
    <inputs>
        <param argument="-i" name="metfrag_vis_input" type="data" format="tsv,tabular" multiple="False" optional="False" label="MetFrag result file (Output tabular file from MetFrag tool)" />
        <param argument="-m" name="metfrag_vis_hits_limit" type="text" value="10" label="MetFrag Hits Limit" optional="False" help="Limit of candidate hits returned per compound" />
        <param argument="-s" name="metfrag_synonyms" type="boolean" truevalue="-s" falsevalue="" checked="true" label="Synonyms" help="Fetch synonyms for each candidate from PubChem"/>
        <param argument="-c" name="metfrag_classyfire"  type="boolean" truevalue="-c" falsevalue="" label="ClassyFire" help="Fetch compound classes for each candidate using ClassyFire"/>
    </inputs>
    <outputs>
        <data name="metfrag_vis_output" format="html" label="Summary HTML file" />
    </outputs>

    <tests>
        <test>
            <param name="metfrag_vis_input" value="metfrag_vis_input.tabular"/>
            <output name="metfrag_vis_output" file="metfrag_vis_output.html" compare="sim_size"/>
        </test>
    </tests>

    <help>
---------------------
MetFrag Visualisation
---------------------

Description
-----------

MetFrag is a freely available software for the annotation of high precision tandem mass spectra of metabolites which is
a first and critical step for the identification of a molecule's structure. Candidate molecules of different databases
are fragmented "in silico" and matched against mass to charge values. A score calculated using the fragment peak
matches gives hints to the quality of the candidate spectrum assignment.

This module summarises the results generated by MetFrag. It takes the (sometimes very large) output tabular file, parses the file and enriches it with images of the spectra showing the extracted and matched peaks and putative structures of the compound candidates. The module supports limiting the results per compound (default 10 candidates). Results can be enriched with further information from PubChem and ClassyFire to make it easier to select candidates. The information is summarised in a HTML5 file which can be viewed directly in Galaxy.

Website: http://ipb-halle.github.io/MetFrag/

Parameters
----------

**\1. Tabular file**

Tabular file created using the *MetFrag* tool.

**\2. MetFrag Hits Limit**

Defines the limit of candidates returned per compound.

**\3. Synonyms**

If set to True, synonyms for each candidate are fetched from PubChem.

**\4. ClassyFire**

If set to True, compound classes are fetched for each candidate using ClassyFire.

Output
-------

The output is similar to the MetFrag results tabular, but enriched with additional images of spectra, compound candidates and (if enabled) compound classes, alternative names and links to online services.

+-------------+--------------------------------------------+---+
| adduct      | name                                       |...|
+-------------+--------------------------------------------+---+
| [M-H]-      | D-Glucose; LC-ESI-QTOF; MS2; CE: 10; R=;   |...|
+-------------+--------------------------------------------+---+
| [M-H]-      | D-Glucose; LC-ESI-QTOF; MS2; CE: 10; R=;   |...|
+-------------+--------------------------------------------+---+
| ...         | ...                                        |...|
+-------------+--------------------------------------------+---+

Table continued (these columns are derived from the MetFrag result):

+---+------------------+----------------------------------------------------------+-------------------------------------------------------------------------------------+-----+
|...| sample_name      | ExplPeaks                                                | FormulasOfExplPeaks                                                                 | ... |
+---+------------------+----------------------------------------------------------+-------------------------------------------------------------------------------------+-----+
|...| 1_metfrag_result | 59.0138_715.8;71.014_679.7;89.0251_999.0;101.0234_103.0  | 59.0138:[C2H4O2]-H-;71.014:[C3H5O2-H]-H-;89.0251:[C3H6O3]-H-;101.0234:[C4H7O3-H]-H- | ... |
+---+------------------+----------------------------------------------------------+-------------------------------------------------------------------------------------+-----+
|...| 1_metfrag_result | 59.0138_715.8;71.014_679.7;89.0251_999.0;101.0234_103.0  | 59.0138:[C2H4O2]-H-;71.014:[C3H5O2-H]-H-;89.0251:[C3H6O3]-H-;101.0234:[C4H7O3-H]-H- | ... |
+---+------------------+----------------------------------------------------------+-------------------------------------------------------------------------------------+-----+
|...| ...              | ...                                                      | ...                                                                                 | ... |
+---+------------------+----------------------------------------------------------+-------------------------------------------------------------------------------------+-----+


Table continued (columns are derived from the MetFrag result):

+---+------------------+----------------------------+------------------------------------------------------+------------+---------------------------------------------------------------------------------+---+
|...| FragmenterScore  | FragmenterScore_Values     | FormulasOfExplPeaks                                  | Identifier | InChI                                                                           |...|
+---+------------------+----------------------------+------------------------------------------------------+------------+---------------------------------------------------------------------------------+---+
|...| 105.844569063138 | 696.0;1156.0;696.0;1156.0  | 6-(hydroxymethyl)oxane-2,3,4,5-tetrol                |  206       | InChI=1S/C6H12O6/c7-1-2-3(8)4(9)5(10)6(11)12-2/h2-11H,1H                        |...|
+---+------------------+----------------------------+------------------------------------------------------+------------+---------------------------------------------------------------------------------+---+
|...| 105.844569063138 | 696.0;1156.0;696.0;1156.0  | (3R,4S,5S,6R)-6-(hydroxymethyl)oxane-2,3,4,5-tetrol  |  5793      | InChI=1S/C6H12O6/c7-1-2-3(8)4(9)5(10)6(11)12-2/h2-11H,1H2/t2-,3-,4+,5-,6?/m1/s1 |...|
+---+------------------+----------------------------+------------------------------------------------------+------------+---------------------------------------------------------------------------------+---+
|...| ...              | ...                        | ...                                                  | ...        | ...                                                                             |...|
+---+------------------+----------------------------+------------------------------------------------------+------------+---------------------------------------------------------------------------------+---+

Table continued (columns are derived from the MetFrag result):


+---+-------------+-----------------+-----------------------+----------------------------------------------+------------------+------------------+--------+
|...| NoExplPeaks | NumberPeaksUsed | OfflineMetFusionScore | SMILES	                                   | Score            | SuspectListScore | XlogP3 |
+---+-------------+-----------------+-----------------------+----------------------------------------------+------------------+------------------+--------+
|...| 4           | 5	            | 2.84566828424078	    | C(C1C(C(C(C(O1)O)O)O)O)O                     | 1.82678219603441 | 1                | -2.6   |
+---+-------------+-----------------+-----------------------+----------------------------------------------+------------------+------------------+--------+
|...| 4           | 5               | 2.84566828424078      | C([C@@H]1[C@H]([C@@H]([C@H](C(O1)O)O)O)O)O   | 1.82678219603441 | 1                | -2.6   |
+---+-------------+-----------------+-----------------------+----------------------------------------------+------------------+------------------+--------+
|...| ...         | ...             | ...                   | ...                                          | ...              | ...              | ...    |
+---+-------------+-----------------+-----------------------+----------------------------------------------+------------------+------------------+--------+

Additional notes
--------------------

This module queries the online services PubChem and ClassyFire.

Feunang YD, Eisner R, Knox C, Chepelev L, Hastings J, Owen G, Fahy E, Steinbeck C, Subramanian S, Bolton E,
Greiner R, Wishart DS (2016): ClassyFire: automated chemical classification with a comprehensive, computable taxonomy. J Cheminform 8:61. doi: 10.1186/s13321-016-0174-y

Kim S, Chen J, Cheng T, Gindulyte A, He J, He S, Li Q, Shoemaker BA, Thiessen PA, Yu B, Zaslavsky L, Zhang J, Bolton EE (2019): PubChem 2019 update: improved access to chemical data. Nucleic Acids Res. 8;47(D1):D1102-D1109. doi: 10.1093/nar/gky1033

Developers and contributors
---------------------------
- **Kristian Peters (kpeters@ipb-halle.de) - IPB Halle (Germany)**
- **Tom Lawson (t.n.lawson@bham.ac.uk) - University of Birmingham (UK)**
- **Christoph Ruttkies (christoph.ruttkies@ipb-halle.de) - IPB Halle (Germany)**
    </help>
    <citations>
        <citation type="doi">10.1186/s13321-016-0115-9</citation>
    </citations>
</tool> 
